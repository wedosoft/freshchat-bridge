# Freshchat-Bridge 종합 분석 보고서

**작성일**: 2025-01-06
**작성자**: System Analysis
**버전**: 1.0

---

## 📋 목차

1. [고객 요청사항 구현 가능 여부](#1-고객-요청사항-구현-가능-여부)
2. [프레시챗/Teams 내장 기능 활용](#2-프레시챗teams-내장-기능-활용)
3. [프로덕션 리팩터링 전략](#3-프로덕션-리팩터링-전략)
4. [구현 계획 및 로드맵](#4-구현-계획-및-로드맵)
5. [의사결정 가이드](#5-의사결정-가이드)

---

## 1. 고객 요청사항 구현 가능 여부

### 1.1 요청사항 목록

고객이 요청한 세 가지 개선사항:

1. **이미지 파일 확장자 문제**: 캡처 이미지가 `*.bin`으로 저장되는 문제
2. **상담원 이름 표시**: "상담원:XXXX" 대신 실제 상담원 이름 표시
3. **비공개 메모 노출**: 비공개 메모가 상대방에게 보이는 문제

### 1.2 구현 가능 여부 분석

#### ✅ 1. 이미지 파일 확장자 문제

**상태**: **구현 가능** (난이도: 낮음)

**현재 상황**:
- Freshchat API는 `file_extension` 필드를 제공함
- 현재 코드가 이 필드를 제대로 활용하지 못함
- MIME 타입(`contentType`)도 제공되나 우선순위가 잘못됨

**해결 방법**:
```javascript
// poc-bridge.js Line ~1682-1722 수정
const attachment = {
  name: part.file.name,
  // 1순위: file_extension 필드 사용
  extension: part.file.file_extension,
  // 2순위: contentType에서 추출
  // 3순위: 파일명에서 추출
  contentType: part.file.content_type || 'application/octet-stream'
};
```

**수정 파일**: `poc-bridge.js` (Line 1682-1722)
**예상 작업량**: 1일
**API 문서 근거**: [Freshchat API - File Object](https://developers.freshchat.com/api/#conversations)

---

#### ✅ 2. 상담원 이름 표시

**상태**: **구현 가능** (난이도: 중간)

**현재 상황**:
- 현재는 "지원팀"이라는 고정 텍스트만 표시
- Freshchat 웹훅에는 `actor_id`만 포함, 이름은 없음

**Freshchat API 확인**:
- ✅ `GET /v2/agents/{agent_id}` 엔드포인트 존재 확인
- ✅ 상담원 이름, 이메일, 상태 정보 포함

**해결 방법**:

**옵션 A**: API 호출 + 캐싱 (권장)
```javascript
// 메모리 캐시 (30분 TTL)
const agentCache = new Map();

async function getAgentName(agentId) {
  const cached = agentCache.get(agentId);
  if (cached && Date.now() - cached.cachedAt < 30*60*1000) {
    return cached.name;
  }

  try {
    const response = await freshchatClient.axiosInstance.get(`/v2/agents/${agentId}`);
    const agent = response.data;
    const name = agent.first_name || agent.email || '지원팀';

    agentCache.set(agentId, { name, cachedAt: Date.now() });
    return name;
  } catch (error) {
    console.error('[Freshchat] Failed to fetch agent:', error);
    return '지원팀'; // 기본값
  }
}
```

**옵션 B**: 웹훅 설정 변경
- Freshchat 관리자 설정에서 웹훅에 상담원 정보 포함 요청
- 현재 가능 여부 확인 필요

**주요 고려사항**:
1. API Rate Limit: 메시지당 1회 추가 API 호출
2. 캐싱으로 성능 영향 최소화 (30분 TTL)
3. API 오류 시 기본값 "지원팀" 사용

**수정 파일**: `poc-bridge.js` (Line 1940, FreshchatClient 클래스)
**예상 작업량**: 2-3일
**API 문서 근거**: [Freshchat API - Agents](https://developers.freshchat.com/api/#agents)

---

#### ✅ 3. 비공개 메모 노출 차단

**상태**: **구현 가능** (난이도: 낮음)

**현재 상황**:
- 모든 agent 메시지를 Teams로 전달
- 비공개/공개 메시지 구분 로직 없음

**Freshchat API 확인**:
- ✅ `message_type` 필드 존재: "normal", "private", "system"
- ✅ `botsPrivateNote` 필드: 봇의 비공개 노트 여부

**해결 방법**:
```javascript
// poc-bridge.js Line ~1664 수정
const allowedActorTypes = new Set(['agent', 'system', 'bot']);
if (!allowedActorTypes.has(actorType)) {
  return res.sendStatus(200);
}

// 추가: 비공개 메시지 필터링
if (message.message_type === 'private' || message.botsPrivateNote === true) {
  console.log('[Freshchat] Skipping private/internal message');
  return res.sendStatus(200);
}
```

**수정 파일**: `poc-bridge.js` (Line 1664)
**예상 작업량**: 1일
**API 문서 근거**: [Freshchat API - Message Types](https://developers.freshchat.com/api/#conversations)

---

### 1.3 종합 요약

| 요청사항 | 구현 가능성 | 난이도 | 예상 작업 기간 | API 지원 |
|---------|-----------|-------|-------------|---------|
| **이미지 파일 확장자** | ✅ 가능 | 🟢 낮음 | 1일 | `file_extension` 필드 |
| **상담원 이름 표시** | ✅ 가능 | 🟡 중간 | 2-3일 | `GET /v2/agents/{id}` |
| **비공개 메모 차단** | ✅ 가능 | 🟢 낮음 | 1일 | `message_type: "private"` |

**총 예상 작업 기간**: 4-5일

---

## 2. 프레시챗/Teams 내장 기능 활용

### 2.1 현재 지원 상태

#### ✅ 이미 지원하는 기능

| 기능 | Freshchat | Teams | 구현 상태 |
|------|-----------|-------|----------|
| 텍스트 메시지 | ✅ `text` | ✅ Plain text | ✅ 구현됨 |
| 파일 첨부 | ✅ `file` | ✅ Attachments | ✅ 구현됨 |
| 이미지 | ✅ `image` | ✅ Image cards | ✅ 구현됨 |
| 비디오 | ✅ `video` | ✅ Video embed | ✅ 구현됨 |
| 이모지 | ✅ Unicode | ✅ Emoji | ✅ 작동 확인 |

### 2.2 구현 가능한 추가 기능

#### 🎯 1. URL 버튼 (지식베이스 문서 공유)

**우선순위**: ⭐⭐⭐⭐⭐ (가장 높음)

**Freshchat 지원**:
```json
{
  "reply_parts": [{
    "url_button": {
      "label": "사용 가이드 보기",
      "url": "https://help.example.com/guide/123"
    }
  }]
}
```

**Teams 변환** (Adaptive Cards):
```json
{
  "type": "AdaptiveCard",
  "version": "1.4",
  "body": [{
    "type": "TextBlock",
    "text": "도움이 필요하신가요?"
  }],
  "actions": [{
    "type": "Action.OpenUrl",
    "title": "사용 가이드 보기",
    "url": "https://help.example.com/guide/123"
  }]
}
```

**구현 복잡도**: 🟢 낮음
**예상 작업량**: 1-2일
**사용자 가치**: 지식베이스 문서를 쉽게 공유 가능

**구현 위치**: `poc-bridge.js` Line 1675 (message_parts 처리 부분)

---

#### 🎯 2. Quick Reply 버튼

**우선순위**: ⭐⭐⭐⭐ (높음)

**Freshchat 지원**:
```json
{
  "reply_parts": [{
    "quick_reply_button": {
      "label": "문의하기",
      "payload": "contact_agent",
      "custom_reply_text": "상담 요청"
    }
  }]
}
```

**Teams 변환** (Adaptive Cards):
```json
{
  "type": "AdaptiveCard",
  "actions": [{
    "type": "Action.Submit",
    "title": "문의하기",
    "data": {
      "action": "quick_reply",
      "payload": "contact_agent",
      "text": "상담 요청"
    }
  }]
}
```

**추가 구현 필요**:
- Teams에서 버튼 클릭 시 응답 처리
- Freshchat으로 사용자 선택 전송

```javascript
// 새 엔드포인트 추가
app.post('/teams/actions', async (req, res) => {
  const action = req.body.data;

  if (action.action === 'quick_reply') {
    await freshchatClient.sendMessage(
      conversationId,
      action.text || action.payload
    );
  }

  res.sendStatus(200);
});
```

**구현 복잡도**: 🟡 중간
**예상 작업량**: 3-4일
**사용자 가치**: 사용자가 버튼으로 빠르게 응답 가능

---

#### 📦 3. 드롭다운 선택

**우선순위**: ⭐⭐⭐ (중간)

**Freshchat 지원**:
```json
{
  "reply_parts": [{
    "template_content": {
      "type": "quick_reply_dropdown",
      "options": [
        {"label": "계좌 개설", "value": "open_account"},
        {"label": "대출 문의", "value": "loan_inquiry"}
      ]
    }
  }]
}
```

**Teams 변환** (Adaptive Cards Input.ChoiceSet):
```json
{
  "type": "Input.ChoiceSet",
  "id": "user_selection",
  "choices": [
    {"title": "계좌 개설", "value": "open_account"},
    {"title": "대출 문의", "value": "loan_inquiry"}
  ],
  "actions": [{
    "type": "Action.Submit",
    "title": "선택"
  }]
}
```

**구현 복잡도**: 🟡 중간
**예상 작업량**: 2-3일
**사용자 가치**: 구조화된 옵션 선택

---

#### 🎨 4. 캐러셀 카드

**우선순위**: ⭐⭐ (낮음)

**Freshchat 지원**:
```json
{
  "reply_parts": [{
    "template_content": {
      "type": "carousel",
      "elements": [
        {
          "title": "상품 A",
          "subtitle": "10,000원",
          "image_url": "https://...",
          "buttons": [...]
        }
      ]
    }
  }]
}
```

**Teams 변환** (Hero Card Carousel):
```json
{
  "attachmentLayout": "carousel",
  "attachments": [{
    "contentType": "application/vnd.microsoft.card.hero",
    "content": {
      "title": "상품 A",
      "subtitle": "10,000원",
      "images": [{"url": "https://..."}],
      "buttons": [...]
    }
  }]
}
```

**구현 복잡도**: 🟡 높음
**예상 작업량**: 4-5일
**사용자 가치**: 여러 옵션을 시각적으로 표시

---

#### ✨ 5. Rich Formatting

**우선순위**: ⭐⭐⭐ (중간)

**지원 항목**:
- **볼드**: `**텍스트**`
- **이탤릭**: `*텍스트*`
- **리스트**: `- 항목`
- **링크**: `[텍스트](URL)`

**구현 복잡도**: 🟢 낮음
**예상 작업량**: 0.5일 (테스트만)
**사용자 가치**: 더 읽기 쉬운 메시지

**참고**: Teams는 Markdown을 네이티브 지원하므로 텍스트를 그대로 전달하면 렌더링됨

---

### 2.3 우선순위별 구현 로드맵

| 순위 | 기능 | 난이도 | 사용자 가치 | 작업량 | 누적 일수 |
|-----|------|-------|-----------|--------|----------|
| **1** | URL 버튼 | 🟢 낮음 | ⭐⭐⭐⭐⭐ | 1-2일 | 1-2일 |
| **2** | Quick Reply 버튼 | 🟡 중간 | ⭐⭐⭐⭐ | 3-4일 | 4-6일 |
| **3** | Rich Formatting | 🟢 낮음 | ⭐⭐⭐ | 0.5일 | 4.5-6.5일 |
| **4** | 드롭다운 선택 | 🟡 중간 | ⭐⭐⭐ | 2-3일 | 6.5-9.5일 |
| **5** | 캐러셀 카드 | 🟡 높음 | ⭐⭐ | 4-5일 | 10.5-14.5일 |

**추천 범위**: 1-3순위 (URL 버튼 + Quick Reply + Rich Formatting)
**예상 기간**: 4.5-6.5일

---

## 3. 프로덕션 리팩터링 전략

### 3.1 현재 아키텍처 분석

#### 문제점

**코드 구조**:
- ✗ **모놀리식**: `poc-bridge.js` 단일 파일 2,090줄
- ✗ **관심사 혼재**: 라우팅, 비즈니스 로직, 데이터 접근 모두 섞임
- ✗ **테스트 불가**: 모듈 분리 없음, 의존성 주입 없음

**멀티테넌트**:
- ✗ **가이드만 존재**: `MULTI_TENANT_GUIDE.md`는 있으나 실제 구현 안 됨
- ✗ **단일 테넌트**: 환경 변수에서 직접 로드, 하드코딩
- ✗ **데이터 격리 없음**: 전역 Map 사용, 테넌트 구분 없음

**데이터 저장**:
- ✗ **메모리 전용**: 재시작 시 모든 매핑 데이터 손실
- ✗ **영속성 없음**: 대화 이력 보존 불가
- ✗ **백업 없음**: 데이터 복구 불가능

**운영**:
- ✗ **테스트 코드 0%**: 단위/통합 테스트 없음
- ✗ **로깅 부족**: `console.log` 사용, 구조화 안 됨
- ✗ **모니터링 없음**: 헬스체크, 메트릭 수집 부재

---

### 3.2 목표 아키텍처

#### 계층 분리

```
┌─────────────────────────────────────┐
│   Routes (Express)                  │  ← HTTP 엔드포인트
├─────────────────────────────────────┤
│   Controllers                       │  ← 요청 처리, 응답 반환
├─────────────────────────────────────┤
│   Services (Business Logic)         │  ← 핵심 비즈니스 로직
├─────────────────────────────────────┤
│   Repositories (Data Access)        │  ← 데이터 CRUD
├─────────────────────────────────────┤
│   Adapters (External APIs)          │  ← Teams, Freshchat API
└─────────────────────────────────────┘
```

#### 디렉토리 구조

```
freshchat-bridge/
├── src/
│   ├── config/                    # 설정 관리
│   │   ├── index.js
│   │   ├── env.config.js
│   │   ├── tenant.config.js
│   │   └── validation.js
│   │
│   ├── middleware/                # Express 미들웨어
│   │   ├── tenant-context.js     # 테넌트 식별
│   │   ├── error-handler.js
│   │   ├── request-logger.js
│   │   └── validation.js
│   │
│   ├── routes/                    # HTTP 라우트
│   │   ├── index.js
│   │   ├── teams.routes.js
│   │   ├── freshchat.routes.js
│   │   ├── admin.routes.js
│   │   └── health.routes.js
│   │
│   ├── controllers/               # 컨트롤러
│   │   ├── teams.controller.js
│   │   ├── freshchat.controller.js
│   │   ├── admin.controller.js
│   │   └── health.controller.js
│   │
│   ├── services/                  # 서비스 계층
│   │   ├── teams/
│   │   │   ├── teams.service.js
│   │   │   ├── teams-message.service.js
│   │   │   └── teams-attachment.service.js
│   │   ├── freshchat/
│   │   │   ├── freshchat.service.js
│   │   │   ├── freshchat-api.service.js
│   │   │   └── freshchat-webhook.service.js
│   │   ├── mapping/
│   │   │   ├── conversation-mapping.service.js
│   │   │   └── deduplication.service.js
│   │   ├── file/
│   │   │   ├── file-upload.service.js
│   │   │   ├── file-download.service.js
│   │   │   └── file-validation.service.js
│   │   └── tenant/
│   │       ├── tenant.service.js
│   │       └── tenant-config.service.js
│   │
│   ├── repositories/              # 데이터 접근
│   │   ├── conversation.repository.js
│   │   ├── tenant.repository.js
│   │   └── adapters/
│   │       ├── storage.interface.js
│   │       ├── memory.adapter.js
│   │       ├── json-file.adapter.js
│   │       └── database.adapter.js
│   │
│   ├── adapters/                  # 외부 통합
│   │   ├── bot-framework.adapter.js
│   │   ├── freshchat-api.adapter.js
│   │   └── file-storage.adapter.js
│   │
│   ├── models/                    # 데이터 모델
│   │   ├── tenant.model.js
│   │   ├── conversation.model.js
│   │   ├── message.model.js
│   │   └── attachment.model.js
│   │
│   ├── utils/                     # 유틸리티
│   │   ├── crypto.js
│   │   ├── validators.js
│   │   ├── formatters.js
│   │   ├── logger.js
│   │   └── errors.js
│   │
│   ├── app.js                     # Express 앱 초기화
│   └── server.js                  # HTTP 서버 시작
│
├── config/                        # 설정 파일
│   ├── tenants.json              # 테넌트 설정
│   ├── tenants.schema.json       # JSON 스키마
│   └── default.json              # 기본 설정
│
├── tests/                         # 테스트
│   ├── unit/
│   ├── integration/
│   └── e2e/
│
├── docs/                          # 문서
│   ├── api/
│   ├── architecture/
│   └── migration/
│
├── scripts/                       # 유틸리티 스크립트
├── uploads/                       # 파일 업로드 (테넌트별)
├── logs/                          # 로그 (테넌트별)
└── poc-bridge.js                 # 레거시 (병렬 실행용)
```

---

### 3.3 멀티테넌트 구현

#### 테넌트 식별 흐름

```
1. HTTP 요청 도착
   ↓
2. Tenant Context Middleware
   - Teams: Bot App ID 추출
   - Freshchat: Inbox ID 추출
   ↓
3. Tenant 조회
   - TenantRepository에서 설정 로드
   - 캐시 활용 (30분 TTL)
   ↓
4. Tenant Context 주입
   - req.tenantContext = { tenantId, tenant, logger }
   ↓
5. Service Layer
   - 모든 작업에 tenantId 사용
   - 데이터 격리 보장
```

#### 테넌트 설정 예시

```json
{
  "defaultTenant": "wedosoft",
  "tenants": [
    {
      "tenantId": "wedosoft",
      "name": "Wedosoft",
      "bot": {
        "appId": "abc-123-...",
        "appPassword": "xyz-456-...",
        "tenantId": "tenant-789-..."
      },
      "freshchat": {
        "apiKey": "fc-key-...",
        "apiUrl": "https://api.freshchat.com/v2",
        "inboxId": "inbox-123",
        "webhookPublicKey": "-----BEGIN PUBLIC KEY-----...",
        "webhookSignatureStrict": true
      },
      "settings": {
        "welcomeMessage": "안녕하세요! 무엇을 도와드릴까요?",
        "publicUrl": "https://wedosoft.fly.dev",
        "uploadsDir": "uploads/wedosoft"
      },
      "branding": {
        "botName": "EXO헬프",
        "botDescription": "EXO 헬프 고객지원",
        "accentColor": "#0078D4"
      },
      "active": true,
      "createdAt": "2024-01-01T00:00:00Z"
    }
  ]
}
```

#### 데이터 격리

| 리소스 | 격리 방법 |
|--------|----------|
| **대화 매핑** | `{tenantId}:{teamsConvId}` 키 사용 |
| **파일 저장** | `uploads/{tenantId}/filename` |
| **로그** | Logger child context: `{ tenantId }` |
| **캐시** | 테넌트별 네임스페이스 |
| **데이터베이스** | `WHERE tenant_id = ?` 조건 |

---

### 3.4 단계별 마이그레이션 계획

#### Phase 1: 기반 구조 (Week 1-2)

**목표**: 모듈 분리, 테스트 인프라 구축

**작업 항목**:
1. ✅ 디렉토리 구조 생성
2. ✅ 유틸리티 추출 (`utils/`)
   - crypto.js (서명 검증)
   - validators.js (입력 검증)
   - formatters.js (데이터 포맷팅)
   - logger.js (Winston 기반)
   - errors.js (커스텀 에러)
3. ✅ 설정 관리 추출 (`config/`)
   - 환경 변수 로더
   - 테넌트 설정 로더
   - JSON 스키마 검증

**예상 작업량**: 5-7일

---

#### Phase 2: 서비스 계층 (Week 3-4)

**목표**: 비즈니스 로직 분리

**작업 항목**:
1. ✅ TeamsService 추출
   - 메시지 처리 로직
   - 첨부파일 처리
   - Bot Framework 통합
2. ✅ FreshchatService 추출
   - API 클라이언트 래핑
   - 대화 생성/관리
   - 메시지 전송
3. ✅ MappingService 추출
   - 대화 매핑 관리
   - 중복 제거
   - GUID/숫자 ID 변환
4. ✅ FileService 추출
   - 파일 업로드/다운로드
   - 파일 검증
   - 스토리지 관리

**예상 작업량**: 5-7일

---

#### Phase 3: 데이터 접근 계층 (Week 5)

**목표**: 스토리지 추상화

**작업 항목**:
1. ✅ Repository 패턴 구현
   - ConversationRepository
   - TenantRepository
2. ✅ Storage Adapter 인터페이스
   - MemoryAdapter (현재 방식)
   - JSONFileAdapter (Phase 2 영속화)
   - DatabaseAdapter (Phase 3 확장)

**예상 작업량**: 3-4일

---

#### Phase 4: HTTP 계층 (Week 6)

**목표**: 라우팅 및 미들웨어 분리

**작업 항목**:
1. ✅ Middleware 구현
   - tenant-context.js
   - error-handler.js
   - request-logger.js
   - validation.js
2. ✅ Routes 분리
   - teams.routes.js
   - freshchat.routes.js
   - admin.routes.js
   - health.routes.js
3. ✅ Controllers 구현
   - 요청 파싱
   - 서비스 호출
   - 응답 반환

**예상 작업량**: 4-5일

---

#### Phase 5: 통합 및 테스트 (Week 7-8)

**목표**: 전체 통합, 테스트, 배포

**작업 항목**:
1. ✅ 의존성 주입 컨테이너
2. ✅ 단위 테스트 (>80% 커버리지)
3. ✅ 통합 테스트
4. ✅ E2E 테스트
5. ✅ 병렬 배포 (레거시 + 신규)
6. ✅ Canary 배포 (10% → 50% → 100%)
7. ✅ 모니터링 및 알림 설정

**예상 작업량**: 7-10일

---

### 3.5 기술 스택 추가 권장사항

| 패키지 | 목적 | 우선순위 |
|--------|------|---------|
| **Winston** | 구조화된 로깅 | 높음 |
| **Joi** 또는 **Zod** | 스키마 검증 | 높음 |
| **helmet** | HTTP 보안 헤더 | 높음 |
| **express-rate-limit** | Rate Limiting | 중간 |
| **node-cache** | 메모리 캐싱 | 중간 |
| **jsonwebtoken** | JWT 인증 (관리자 API) | 중간 |
| **pg** 또는 **mongodb** | 데이터베이스 (Phase 3) | 낮음 |

---

### 3.6 예상 작업 기간 및 리소스

#### 시간 추정

| 시나리오 | 기간 | 전제 조건 |
|---------|------|----------|
| **최선** | 5주 | 풀타임 집중, 블로커 없음 |
| **현실** | 7-8주 | 70% 집중, 일부 이슈 |
| **보수** | 10-12주 | 50% 집중, 통합 어려움 |

#### Phase별 분배

| Phase | 작업 내용 | 예상 일수 | 누적 주차 |
|-------|----------|----------|----------|
| Phase 1 | 기반 구조, 유틸리티 | 5-7일 | 1-2주 |
| Phase 2 | 서비스 계층 | 5-7일 | 3-4주 |
| Phase 3 | 데이터 접근 | 3-4일 | 5주 |
| Phase 4 | HTTP 계층 | 4-5일 | 6주 |
| Phase 5 | 통합, 테스트 | 7-10일 | 7-8주 |

**총 예상 기간**: 7-8주 (현실적 시나리오)

---

## 4. 구현 계획 및 로드맵

### 4.1 세 가지 실행 옵션

#### 옵션 A: 빠른 개선 (2-3주)

**범위**:
- ✅ 고객 요청사항 3가지
- ✅ URL 버튼 + Quick Reply

**일정**:
```
Week 1: 고객 요청사항
  Day 1: 비공개 메모 필터링
  Day 2: 이미지 파일 확장자
  Day 3-5: 상담원 이름 표시

Week 2: 내장 기능
  Day 1-2: URL 버튼 구현
  Day 3-5: Quick Reply 구현

Week 3: 테스트 및 배포
  Day 1-3: 통합 테스트
  Day 4-5: 프로덕션 배포
```

**장점**:
- ✅ 빠른 가치 제공 (2-3주)
- ✅ 위험 낮음 (기존 코드 최소 변경)
- ✅ 즉각적인 사용자 만족도 향상

**단점**:
- ✗ 기술 부채 계속 누적
- ✗ 확장성 제한
- ✗ 멀티테넌트 미지원

**추천 대상**: 빠른 개선이 급한 경우

---

#### 옵션 B: 전면 리팩터링 (7-8주)

**범위**:
- ✅ 완전한 아키텍처 재설계
- ✅ 진정한 멀티테넌트
- ✅ 테스트 인프라 (80%+ 커버리지)
- ✅ 프로덕션 준비 (로깅, 모니터링, 에러 핸들링)

**일정**: Phase 1-5 전체 (위 3.4절 참조)

**장점**:
- ✅ 장기적 유지보수성
- ✅ 확장성 (50+ 테넌트)
- ✅ 개발 속도 향상 (리팩터링 후)
- ✅ 품질 향상 (테스트 커버리지)

**단점**:
- ✗ 초기 투자 큼 (7-8주)
- ✗ 단기 ROI 낮음
- ✗ 배포 리스크 높음

**추천 대상**: 장기 투자 가능, 확장 계획 있음

---

#### 옵션 C: 혼합 전략 ⭐ (권장)

**범위**:
- Phase 1 (2주): 고객 요청 + 내장 기능
- Phase 2 (4주): 점진적 리팩터링
- Phase 3 (2주): 통합 및 마이그레이션

**일정**:
```
Week 1-2: 즉시 개선
  - 고객 요청사항 3가지 구현
  - URL 버튼 + Quick Reply 구현
  - 프로덕션 배포
  → 즉각적인 가치 제공

Week 3-6: 점진적 리팩터링
  - 레거시 코드 유지 (Port 3979)
  - 신규 아키텍처 구축 (Port 3978)
  - Phase 1-4 실행 (모듈화, 서비스 분리)
  → 병렬 개발, 위험 최소화

Week 7-8: 통합 및 전환
  - 통합 테스트
  - Canary 배포 (10% → 50% → 100%)
  - 레거시 코드 제거
  → 안전한 마이그레이션
```

**장점**:
- ✅ 빠른 가치 제공 (2주 내)
- ✅ 장기 개선 동시 진행
- ✅ 위험 분산 (병렬 배포)
- ✅ 점진적 마이그레이션

**단점**:
- ⚠️ 복잡도 증가 (두 버전 관리)
- ⚠️ 코드 동기화 필요

**추천 대상**: 대부분의 경우 (균형잡힌 접근)

---

### 4.2 우선순위 매트릭스

#### 가치 vs 노력

```
높은 가치 ▲
        │
        │  [비공개 메모]     [상담원 이름]
        │   (1일, 높음)      (2-3일, 높음)
        │
        │  [URL 버튼]       [Quick Reply]
        │  (1-2일, 매우높음)  (3-4일, 높음)
        │
        │  [이미지 확장자]
        │   (1일, 높음)
        │
        │                    [리팩터링]
        │                    (7-8주, 장기)
        │
낮은 가치 ▼
        └──────────────────────────────►
          낮은 노력            높은 노력
```

#### 추천 순서

1. **Quick Wins** (1-2주):
   - 비공개 메모 차단
   - 이미지 파일 확장자
   - URL 버튼

2. **High Value** (3-4주):
   - 상담원 이름 표시
   - Quick Reply 버튼

3. **Long-term** (5-8주):
   - 점진적 리팩터링
   - 멀티테넌트 구현

---

### 4.3 위험 관리

#### 식별된 위험

| 위험 | 확률 | 영향 | 완화 전략 |
|------|------|------|----------|
| **API Rate Limit** (상담원 이름) | 중간 | 중간 | 캐싱 (30분 TTL), 폴백 값 |
| **배포 중단** (리팩터링) | 낮음 | 높음 | 병렬 배포, Canary 릴리스 |
| **데이터 손실** (마이그레이션) | 낮음 | 높음 | 백업, 롤백 계획 |
| **성능 저하** (추가 API 호출) | 중간 | 낮음 | 캐싱, 비동기 처리 |
| **통합 문제** (새 기능) | 중간 | 중간 | 통합 테스트, 스테이징 검증 |

#### 롤백 계획

**트리거 조건**:
- 메시지 전달 실패율 >5%
- 에러율 >10%
- 레이턴시 2배 이상 증가

**롤백 단계**:
1. 로드밸런서를 레거시 포트로 전환
2. 신규 버전 중단
3. 로그 수집 및 원인 분석
4. 수정 후 재배포

---

## 5. 의사결정 가이드

### 5.1 의사결정 트리

```
Q1: 얼마나 빨리 필요한가?
├─ 1주 이내 급함
│  └─→ [옵션 A] 고객 요청사항만 (비공개 메모, 이미지, 상담원 이름)
│
├─ 2-3주 여유 있음
│  └─→ [옵션 A] 고객 요청 + URL 버튼 + Quick Reply
│
└─ 2개월 장기 투자 가능
   └─→ Q2: 멀티테넌트가 필요한가?
       ├─ 예 → [옵션 C] 혼합 전략 (즉시 개선 + 리팩터링)
       └─ 아니오 → [옵션 A] 빠른 개선만
```

### 5.2 체크리스트

구현 전 확인사항:

#### 비즈니스 요구사항
- [ ] 어떤 기능이 가장 시급한가?
- [ ] 예산 및 리소스 제약은?
- [ ] 멀티테넌트가 필수인가?
- [ ] 확장 계획은? (사용자 수, 테넌트 수)

#### 기술 요구사항
- [ ] 현재 시스템 안정성 수준은?
- [ ] 테스트 환경이 있는가?
- [ ] 롤백 계획이 있는가?
- [ ] 모니터링 시스템이 있는가?

#### 팀 역량
- [ ] 리팩터링 경험이 있는가?
- [ ] 병렬 배포 경험이 있는가?
- [ ] 풀타임 투입 가능한가?
- [ ] 지식 이전 계획이 있는가?

---

### 5.3 추천 결정

#### 대부분의 경우 (80%)

**[옵션 C] 혼합 전략** 추천

**이유**:
- ✅ 빠른 가치 제공 (2주 내)
- ✅ 장기 개선 동시 진행
- ✅ 위험 분산
- ✅ 점진적 마이그레이션

**실행 계획**:
```bash
# Week 1-2: 즉시 개선
git checkout -b feature/quick-improvements
# 고객 요청 + URL/Quick Reply 구현

# Week 3-6: 리팩터링
git checkout -b refactor/production-architecture
# 병렬 개발 (레거시 유지)

# Week 7-8: 마이그레이션
# Canary 배포 → 100% 전환
```

---

#### 긴급한 경우 (15%)

**[옵션 A] 빠른 개선** 추천

**이유**:
- 1-2주 내 결과 필요
- 위험 최소화
- 리소스 제약

**실행 계획**:
```bash
git checkout -b feature/urgent-fixes
# 비공개 메모 + 이미지 + 상담원 이름만
```

---

#### 장기 투자 가능한 경우 (5%)

**[옵션 B] 전면 리팩터링** 추천

**이유**:
- 7-8주 투자 가능
- 완벽한 아키텍처 필요
- 멀티테넌트 필수

**실행 계획**:
```bash
git checkout -b refactor/multi-tenant-architecture
# Phase 1-5 전체 실행
```

---

## 부록

### A. API 문서 참고 링크

- [Freshchat API - Conversations](https://developers.freshchat.com/api/#conversations)
- [Freshchat API - Agents](https://developers.freshchat.com/api/#agents)
- [Microsoft Teams - Adaptive Cards](https://learn.microsoft.com/en-us/microsoftteams/platform/task-modules-and-cards/what-are-cards)
- [Bot Framework SDK](https://docs.microsoft.com/en-us/azure/bot-service/)

### B. 코드 수정 위치 요약

| 기능 | 파일 | 라인 | 예상 변경 |
|------|------|------|----------|
| 비공개 메모 차단 | poc-bridge.js | 1664 | +5줄 |
| 이미지 확장자 | poc-bridge.js | 1682-1722 | 수정 20줄 |
| 상담원 이름 | poc-bridge.js | 1940, FreshchatClient | +50줄 |
| URL 버튼 | poc-bridge.js | 1675 | +80줄 |
| Quick Reply | poc-bridge.js | 1675, 새 엔드포인트 | +150줄 |

### C. 데이터베이스 스키마 (Phase 3)

```sql
-- 테넌트 테이블
CREATE TABLE tenants (
    tenant_id VARCHAR(100) PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    bot_app_id VARCHAR(255) NOT NULL UNIQUE,
    bot_app_password VARCHAR(255) NOT NULL,
    freshchat_api_key VARCHAR(255) NOT NULL,
    freshchat_inbox_id VARCHAR(100) NOT NULL UNIQUE,
    active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 대화 매핑 테이블
CREATE TABLE conversation_mappings (
    id SERIAL PRIMARY KEY,
    tenant_id VARCHAR(100) REFERENCES tenants(tenant_id),
    teams_conversation_id VARCHAR(255) NOT NULL,
    freshchat_conversation_guid VARCHAR(255),
    freshchat_user_id VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(tenant_id, teams_conversation_id)
);

-- 처리된 메시지 테이블 (중복 방지)
CREATE TABLE processed_messages (
    id SERIAL PRIMARY KEY,
    tenant_id VARCHAR(100) REFERENCES tenants(tenant_id),
    message_id VARCHAR(255) NOT NULL,
    processed_at TIMESTAMP DEFAULT NOW(),
    expires_at TIMESTAMP NOT NULL,
    UNIQUE(tenant_id, message_id)
);
```

### D. 성공 지표

| 지표 | 현재 | 목표 | 측정 방법 |
|------|------|------|----------|
| 코드 복잡도 | 2,090줄/파일 | <500줄/파일 | 파일 크기 |
| 테스트 커버리지 | 0% | >80% | Jest coverage |
| 배포 시간 | ~10분 | <5분 | CI/CD 파이프라인 |
| 버그 수정 시간 | 3-5일 | <1일 | 이슈 트래킹 |
| 메시지 레이턴시 | 불명 | <2초 | Prometheus |
| 에러율 | 불명 | <1% | 로그 분석 |

---

## 다음 단계

1. **의사결정**: 위 5.1절 의사결정 트리를 참고하여 옵션 선택
2. **승인**: 선택한 옵션의 타임라인 및 리소스 승인
3. **브랜치 생성**: `git checkout -b [선택한-브랜치-명]`
4. **구현 시작**: 선택한 옵션의 Week 1 작업부터 시작
5. **정기 리뷰**: 주간 진행상황 리뷰 및 조정

---

**문서 작성**: 2025-01-06
**다음 업데이트**: 구현 시작 후 주간 업데이트
**문의**: 구현 관련 질문은 이 문서를 참조하여 논의
