아래 설계는 **MVP 기준의 전체 아키텍처**입니다. 목적은 **Teams(채널/DM) ↔ Freshchat(라우팅/IntelliAssign)** 간 **양방향 메시지 브리지**를 SLA 관점에서 안전하게 구현하는 것입니다. 문서는 **AI Agent 작업 지침서**로 바로 사용 가능하도록 **구성/계약/운영**까지 포함합니다.

# 1) 목표·범위(MVP)

* **목표**:

  1. Teams 메시지 → Freshchat 대화 생성/추가
  2. Freshchat 에이전트 답변 → 원 Teams 스레드 회신
  3. 채널↔인박스 매핑·태그 주입으로 **라우팅/IntelliAssign** 작동
* **범위**: 텍스트·이미지(소형)·멘션(기본)·스레드 유지, 상태(열림/종료) 알림(옵션)
* **SLO(초안)**: p95 E2E ≤ 2.5s, 월 가용성 ≥ 99.9%, 메시지 손실 0

# 2) 아키텍처(요약)

* **Teams Bot**: 채널/DM 수신·송신, 스레드 컨텍스트 유지
* **API Gateway/WAF**: TLS, 속도 제한, IP 허용, 서명 검증 위임
* **Event Queue(+DLQ)**: 비동기 처리·재시도·아이템포턴시
* **Normalizer(코어)**: 포맷/멘션/이모지 정규화, 라우팅 메타 주입
* **Freshchat Adapter**: 대화/메시지/첨부 API 호출, 태그·속성 전달
* **Teams Adapter**: Graph/봇 송신, 길이 제한 폴백
* **State Store**: 스레드/사용자 매핑, 채널↔인박스 매핑
* **Object Storage**: 첨부 프록시(서명 URL), AV 스캔(경량)
* **Obs 스택**: 로그·메트릭·트레이싱, 대시보드/알림

> 클라우드 예시
>
> * Azure: Bot Service, API Management, Service Bus, Container Apps/AKS, Blob, Key Vault, Monitor
> * AWS: API GW+WAF, SQS/SNS, ECS Fargate/Lambda(엣지), S3, KMS, CloudWatch

# 3) 데이터 플로우(E2E)

A. **Teams→Ingress**: Bot 콜백 수신 → Gateway 검증 → **Queue(ingress)**
B. **정규화**: Normalizer가 멘션·서식 변환, **라우팅 태그** 주입
C. **Freshchat 전송**: 기존 대화 조회/없으면 생성 → 메시지 POST(태그/속성 포함)
D. **Freshchat→Teams**: Freshchat Webhook 수신 → **Queue(egress)** → Teams Adapter → 원 스레드 회신
E. **상태 싱크(옵션)**: 종료/재오픈 이벤트를 Ops 채널로 요약 알림

# 4) 표준 메시지 스키마(코어 이벤트)

```json
{
  "idempotencyKey": "teams:<team>/<channel>/<thread>/<messageId>",
  "tenantId": "TENANT_01",
  "direction": "inbound|outbound",
  "source": "teams|freshchat",
  "context": {
    "teamId": "...", "channelId": "...", "threadId": "...",
    "user": {"aadUserIdHash": "abc..."},
    "conversationId": "freshchat:123456"  // 역방향 시 존재
  },
  "content": {
    "text": "사용자 문의",
    "mentions": [{"type":"user","display":"@Helpdesk"}],
    "attachments": [{"type":"image","name":"img.png","signedUrl":"..."}]
  },
  "routing": {
    "tags": ["teams","product:x","region:kr","priority:normal"],
    "customAttributes": {"source":"teams","channel":"ops-seoul"}
  },
  "timestamp": "2025-10-23T00:00:00Z"
}
```

# 5) 주요 인터페이스 계약(요약)

**1) Teams Bot 콜백**

* `POST /bot/callback`
* 인증: Bot 채널 서명 검증(JWT)
* 처리: 200 즉시 응답 → 이벤트는 Queue 적재(동기 처리 금지)

**2) Freshchat Webhook**

* `POST /freshchat/webhook`
* 인증: `X-Freshchat-Signature` HMAC 검증
* 처리: 2xx 즉시 응답 → Queue 적재

**3) Queue 메시지**

* Body: “표준 메시지 스키마”
* 속성: `idempotencyKey`, `retryCount`, `source`

**4) 외부 API 호출(어댑터) – 최소 구현**

* Freshchat: Conversation 조회/생성, Message 전송, Media 업로드
* Teams: 채널/DM `chatMessage` 전송(스레드 유지), 첨부 사전 업로드

# 6) 라우팅/IntelliAssign 연동

* **채널↔인박스 매핑 테이블**(State Store)

  * Key: `tenantId+teamId+channelId` → `freshchatInboxId`
* **규칙 신호 전달**

  * `routing.tags` → Freshchat **tags**
  * `routing.customAttributes` → Freshchat **custom_attributes**
* **IntelliAssign 전제**: 에이전트 스킬/근무시간은 Freshchat에 선구성

# 7) 상태·매핑 모델

* **Thread Map**: `teamId/channelId/threadId ↔ freshchatConversationId`(+TTL)
* **User Map**: `aadUserIdHash ↔ freshchatUserId`
* **Attachment Map**: 원본 보안 URL ↔ 임시 서명 URL(만료시간)

# 8) 보안·권한(필수)

* **OAuth 최소 스코프**(Teams Graph), 테넌트 관리자 동의
* 웹훅 **서명 검증**(Freshchat), Bot JWT 검증(Teams)
* **비밀 키**: KMS/Key Vault 관리·회전, 전구간 TLS
* **PII 최소화**: 해시·가명 처리, 보존기간·파기정책 명시

# 9) 성능·신뢰성

* **아이템포턴시**: `idempotencyKey` 기반 중복 수신 제거
* **재시도**: 429/5xx 지수 백오프, 한도 초과 시 **DLQ** 격리
* **스로틀링**: 외부 API 호출 RateLimiter(토큰버킷), 큐 기반 백프레셔
* **대용량 메시지**: 텍스트 길이 초과 시 요약 + “원문 링크” 폴백
* **첨부**: 10MB 이하 이미지 우선, 기타 파일은 링크 전송

# 10) 관찰가능성(Obs)

* **로그**: 구조화(JSON), 오류 코드/외부 API 응답시간
* **트레이싱**: correlationId = `TeamsMsgId` / `FreshchatMsgId` / `conversationId`
* **메트릭**: TPS, p95/99, 실패율, 큐 적체, 외부 API 429/5xx 비율
* **알림**: SLO 위반, 큐 적체 임계, DLQ 증가

# 11) 배포·릴리스

* **IaC**: Terraform / Bicep / CDK 중 택1, `dev→stg→prod` 3계층
* **릴리스 전략**: 파일럿 팀(1~2 채널) → 부서 단위 점진 롤아웃
* **피처 플래그**: 멘션 변환/이미지 전송/상태 알림 토글

# 12) 테스트 계획(Agent 실행용 체크)

* **계약 테스트**: Webhook 서명/JWT 검증, 표준 스키마 준수
* **부하 테스트**: 피크 예상의 2×(버스트 1분) → p95 ≤ 2.5s 확인
* **장애 시나리오**: Freshchat 5xx, Graph 429, 스토리지 실패 → 재시도/폴백 동작
* **UAT 케이스**

  * 채널 A → 인박스 X 라우팅·IntelliAssign 배정
  * 동일 스레드 내 왕복 5회전, 멘션/이미지 포함
  * 종료 후 재오픈 메시지 처리

# 13) 운영 SOP(요약)

* **장애 레벨링**:

  * L1: 외부 API 429 증가 → RateLimiter 상향/큐 감속
  * L2: DLQ 누적 → 원인 라벨 확인 후 재처리 툴로 복구
  * L3: 인증 실패 급증 → 키 회전/권한 재동의 가이드 배포
* **DLQ 재처리 절차**: 원인코드별 배치 재시도, 실패 3회↑는 수동 조치
* **키 회전**: Freshchat 서명/Graph 비밀, 분기별 자동 회전

# 14) 구성 값(초기 파라미터)

* `freshchatBaseUrl`, `freshchatApiKey`, `webhookSigningSecret`
* `graphTenantId`, `clientId`, `clientSecret`, `botAppId`
* `defaultInboxId`, `channelInboxMap[]`
* 제한값: `maxTextLength`, `maxImageSizeMB`, `retryBackoff`, `rateLimitRPS`

# 15) MVP 작업 분해(에이전트 태스크)

1. **Bot 콜백 엔드포인트** 구현 + JWT 검증
2. **Freshchat Webhook** 엔드포인트 + HMAC 검증
3. **Queue/DLQ** 생성, 표준 스키마 퍼블리시/컨슘러 템플릿
4. **Normalizer**: 멘션/링크/이모지 정규화, 라우팅 태그 주입
5. **Freshchat Adapter**: 대화 조회/생성, 메시지/이미지 전송
6. **Teams Adapter**: 스레드 유지 송신, 길이 제한 폴백
7. **State Store**: 스레드/사용자/채널↔인박스 매핑 CRUD
8. **Obs**: 구조화 로그, 기본 메트릭(p95/실패율), 경보 룰
9. **관리 콘솔(경량)**: 채널↔인박스 매핑/태그 규칙 UI
10. **테스트 시나리오** 자동화(계약·부하·장애)

---

위 구성을 기준으로 **API 스펙(요청/응답 JSON)**, **Terraform 모듈 스켈레톤**, **메시지 변환 유닛테스트 예시**까지 바로 제공해드릴 수 있습니다. 다음 단계는 **채널↔인박스 매핑 규칙**과 **최대 첨부 정책(크기/타입)** 확정입니다.
